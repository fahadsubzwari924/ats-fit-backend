<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ATS Score Test Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }

        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-style: italic;
        }

        .user-type-selector {
            background: #e8f4fd;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 30px;
            border-left: 4px solid #007bff;
        }

        .user-type-selector h3 {
            margin: 0 0 15px 0;
            color: #0056b3;
        }

        .user-type-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .user-type-option {
            flex: 1;
            min-width: 200px;
        }

        .user-type-option input[type="radio"] {
            margin-right: 8px;
        }

        .user-type-option label {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border: 2px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .user-type-option input[type="radio"]:checked+label {
            border-color: #007bff;
            background: #f8f9ff;
            font-weight: bold;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        textarea {
            height: 120px;
            resize: vertical;
        }

        .file-upload-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 6px;
            border: 2px dashed #dee2e6;
            margin: 20px 0;
            transition: all 0.3s;
        }

        .file-upload-section.disabled {
            background: #e9ecef;
            opacity: 0.6;
        }

        .file-upload-section.required {
            border-color: #dc3545;
            background: #fff5f5;
        }

        .file-upload-section.optional {
            border-color: #28a745;
            background: #f8fff9;
        }

        .file-status {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .status-required {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-optional {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-forbidden {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 30px;
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .test-btn {
            background-color: #28a745;
        }

        .test-btn:hover {
            background-color: #1e7e34;
        }

        .clear-btn {
            background-color: #6c757d;
        }

        .clear-btn:hover {
            background-color: #545b62;
        }

        .result {
            margin-top: 30px;
            padding: 20px;
            border-radius: 4px;
            display: none;
        }

        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }

        .loading {
            text-align: center;
            color: #666;
            display: none;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 2s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        pre {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }

        .ats-score-display {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin: 20px 0;
        }

        .ats-score-display h3 {
            margin: 0 0 10px 0;
            font-size: 24px;
        }

        .ats-score-display .score {
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }

        .test-scenarios {
            background: #e7f3ff;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #2196F3;
        }

        .test-scenarios h4 {
            margin: 0 0 15px 0;
            color: #1976D2;
        }

        .scenario {
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #2196F3;
        }

        .metadata-section {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            margin: 15px 0;
        }

        .metadata-section h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }

        .toggle-section {
            margin: 10px 0;
        }

        .toggle-section summary {
            cursor: pointer;
            font-weight: bold;
            padding: 10px;
            background: #e9ecef;
            border-radius: 4px;
            border: none;
            outline: none;
        }

        .toggle-section[open] summary {
            background: #dee2e6;
        }

        .validation-info {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .validation-info h4 {
            margin: 0 0 10px 0;
            color: #856404;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>🎯 ATS Score Test Page</h1>
        <p class="subtitle">
            Test the enhanced ATS scoring endpoint with smart resume detection and validation
        </p>

        <div class="test-scenarios">
            <h4>🧪 Test Scenarios Covered:</h4>
            <div class="scenario">
                <strong>Guest User:</strong> Must always upload a resume file
            </div>
            <div class="scenario">
                <strong>Registered User (No Processed Resume):</strong> Must upload a resume file
            </div>
            <div class="scenario">
                <strong>Registered User (With Processed Resume):</strong> Cannot upload file - uses database resume
            </div>
            <div class="scenario">
                <strong>Premium User (With Processed Resume):</strong> Cannot upload file - uses database resume
            </div>
        </div>

        <div class="user-type-selector">
            <h3>👤 Select User Type to Test</h3>
            <div class="user-type-options">
                <div class="user-type-option">
                    <input type="radio" id="guest" name="userType" value="guest" checked>
                    <label for="guest">
                        <span>🚶 Guest User<br><small>Always requires file upload</small></span>
                    </label>
                </div>
                <div class="user-type-option">
                    <input type="radio" id="registered-no-resume" name="userType" value="registered-no-resume">
                    <label for="registered-no-resume">
                        <span>👤 Registered (No Resume)<br><small>Requires file upload</small></span>
                    </label>
                </div>
                <div class="user-type-option">
                    <input type="radio" id="registered-with-resume" name="userType" value="registered-with-resume">
                    <label for="registered-with-resume">
                        <span>👤 Registered (Has Resume)<br><small>Uses database resume</small></span>
                    </label>
                </div>
                <div class="user-type-option">
                    <input type="radio" id="premium-with-resume" name="userType" value="premium-with-resume">
                    <label for="premium-with-resume">
                        <span>💎 Premium (Has Resume)<br><small>Uses database resume</small></span>
                    </label>
                </div>
            </div>
        </div>

        <form id="atsScoreForm">
            <div class="form-group">
                <label for="jobDescription">Job Description *</label>
                <textarea id="jobDescription" name="jobDescription" required
                    placeholder="Enter the job description here...">We are looking for a Senior Software Engineer with expertise in Node.js, TypeScript, and cloud technologies. The ideal candidate should have experience with microservices architecture, Docker, and AWS services. You will be responsible for designing and implementing scalable backend systems, working with databases, and collaborating with frontend developers. Strong problem-solving skills and experience with agile development methodologies are essential.</textarea>
            </div>

            <div class="form-group">
                <label for="companyName">Company Name (Optional)</label>
                <input type="text" id="companyName" name="companyName" placeholder="e.g., TechCorp Inc"
                    value="TechCorp Inc">
            </div>

            <div class="file-upload-section" id="fileUploadSection">
                <label for="resumeFile">Resume File (PDF)</label>
                <input type="file" id="resumeFile" name="resumeFile" accept=".pdf">
                <small style="color: #666; font-size: 12px;">
                    Select a PDF file containing your resume content
                </small>
                <div class="file-status" id="fileStatus">
                    <!-- Status will be updated based on user type -->
                </div>
            </div>

            <div class="validation-info">
                <h4>⚠️ Current Validation Rules:</h4>
                <ul id="validationRules">
                    <!-- Rules will be updated based on user type -->
                </ul>
            </div>

            <div class="buttons">
                <button type="button" id="testBtn" class="test-btn">🎯 Calculate ATS Score</button>
                <button type="button" id="clearBtn" class="clear-btn">🗑️ Clear Results</button>
            </div>
        </form>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Calculating your ATS score...</p>
        </div>

        <div class="result" id="result"></div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:3000/api/v1';

        // Mock user contexts for different scenarios
        const USER_CONTEXTS = {
            'guest': {
                userType: 'guest',
                guestId: 'guest-' + Date.now(),
                headers: {}
            },
            'registered-no-resume': {
                userType: 'registered',
                userId: 'user-no-resume-' + Date.now(),
                headers: {
                    'Authorization': 'Bearer mock-jwt-token-no-resume'
                }
            },
            'registered-with-resume': {
                userType: 'registered',
                userId: 'user-with-resume-' + Date.now(),
                headers: {
                    'Authorization': 'Bearer mock-jwt-token-with-resume'
                }
            },
            'premium-with-resume': {
                userType: 'premium',
                userId: 'premium-user-' + Date.now(),
                headers: {
                    'Authorization': 'Bearer mock-jwt-token-premium'
                }
            }
        };

        document.getElementById('testBtn').addEventListener('click', handleAtsScoreTest);
        document.getElementById('clearBtn').addEventListener('click', clearResults);

        // Update UI when user type changes
        document.querySelectorAll('input[name="userType"]').forEach(radio => {
            radio.addEventListener('change', updateUIForUserType);
        });

        // Initialize UI
        updateUIForUserType();

        function updateUIForUserType() {
            const selectedUserType = document.querySelector('input[name="userType"]:checked').value;
            const fileUploadSection = document.getElementById('fileUploadSection');
            const fileStatus = document.getElementById('fileStatus');
            const validationRules = document.getElementById('validationRules');
            const resumeFileInput = document.getElementById('resumeFile');

            // Reset classes
            fileUploadSection.className = 'file-upload-section';

            switch (selectedUserType) {
                case 'guest':
                    fileUploadSection.classList.add('required');
                    resumeFileInput.required = true;
                    fileStatus.innerHTML = '<div class="status-required">📁 File upload REQUIRED for guest users</div>';
                    validationRules.innerHTML = `
                        <li>✅ Must provide resume file (validation in business logic)</li>
                        <li>✅ File will be validated by FileValidationPipe (format, size, content)</li>
                        <li>✅ No authentication required</li>
                    `;
                    break;

                case 'registered-no-resume':
                    fileUploadSection.classList.add('required');
                    resumeFileInput.required = true;
                    fileStatus.innerHTML = '<div class="status-required">📁 File upload REQUIRED (no processed resume in database)</div>';
                    validationRules.innerHTML = `
                        <li>✅ Must provide resume file (no processed resume exists)</li>
                        <li>✅ File will be validated by FileValidationPipe</li>
                        <li>✅ Requires authentication token</li>
                        <li>✅ Resume will be processed and stored for future use</li>
                    `;
                    break;

                case 'registered-with-resume':
                    fileUploadSection.classList.add('disabled');
                    resumeFileInput.required = false;
                    fileStatus.innerHTML = '<div class="status-forbidden">🚫 File upload FORBIDDEN (processed resume exists in database)</div>';
                    validationRules.innerHTML = `
                        <li>❌ Cannot upload file (validation error will be thrown)</li>
                        <li>✅ Will use existing processed resume from database</li>
                        <li>✅ Requires authentication token</li>
                        <li>⚠️ If file is provided, expect HTTP 400 error</li>
                    `;
                    break;

                case 'premium-with-resume':
                    fileUploadSection.classList.add('disabled');
                    resumeFileInput.required = false;
                    fileStatus.innerHTML = '<div class="status-forbidden">🚫 File upload FORBIDDEN (processed resume exists in database)</div>';
                    validationRules.innerHTML = `
                        <li>❌ Cannot upload file (validation error will be thrown)</li>
                        <li>✅ Will use existing processed resume from database</li>
                        <li>✅ Premium features enabled</li>
                        <li>✅ Requires authentication token</li>
                        <li>⚠️ If file is provided, expect HTTP 400 error</li>
                    `;
                    break;
            }

            console.log('UI updated for user type:', selectedUserType);
        }

        async function handleAtsScoreTest() {
            const formData = getFormData();
            if (!formData) return;

            const selectedUserType = document.querySelector('input[name="userType"]:checked').value;
            const userContext = USER_CONTEXTS[selectedUserType];

            try {
                showLoading(true);
                hideResult();

                console.log('Testing ATS score endpoint with user type:', selectedUserType);
                console.log('User context:', userContext);
                console.log('Form data:', {
                    jobDescription: formData.get('jobDescription').substring(0, 50) + '...',
                    companyName: formData.get('companyName'),
                    hasFile: !!formData.get('resumeFile')
                });

                const requestOptions = {
                    method: 'POST',
                    body: formData,
                    headers: {
                        ...userContext.headers
                    }
                };

                console.log('Making request to:', `${API_BASE_URL}/ats-match/score`);
                console.log('Request headers:', requestOptions.headers);

                const response = await fetch(`${API_BASE_URL}/ats-match/score`, requestOptions);

                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                const result = await response.json();
                console.log('Response data:', result);

                if (response.ok) {
                    showSuccess(result, selectedUserType);
                } else {
                    showError(result, selectedUserType, response.status);
                }

            } catch (error) {
                console.error('Request failed:', error);
                showError({
                    message: `Network error: ${error.message}`,
                    code: 'NETWORK_ERROR'
                }, selectedUserType);
            } finally {
                showLoading(false);
            }
        }

        function getFormData() {
            const selectedUserType = document.querySelector('input[name="userType"]:checked').value;
            const formData = new FormData();

            // Validate required fields
            const jobDescription = document.getElementById('jobDescription').value.trim();
            const companyName = document.getElementById('companyName').value.trim();
            const resumeFile = document.getElementById('resumeFile').files[0];

            if (!jobDescription) {
                alert('Job description is required.');
                return null;
            }

            // Validate file requirements based on user type
            if ((selectedUserType === 'guest' || selectedUserType === 'registered-no-resume') && !resumeFile) {
                alert(`File upload is required for ${selectedUserType.replace('-', ' ')} users.`);
                return null;
            }

            // Warn about file upload for users with processed resumes
            if ((selectedUserType === 'registered-with-resume' || selectedUserType === 'premium-with-resume') && resumeFile) {
                const proceed = confirm(
                    '⚠️ You selected a user type that has a processed resume in the database.\n\n' +
                    'Uploading a file should result in a validation error (HTTP 400).\n\n' +
                    'Do you want to proceed to test the validation error?'
                );
                if (!proceed) return null;
            }

            formData.append('jobDescription', jobDescription);
            if (companyName) {
                formData.append('companyName', companyName);
            }
            if (resumeFile) {
                formData.append('resumeFile', resumeFile);
            }

            console.log('Form data prepared for user type:', selectedUserType, {
                jobDescription: jobDescription.substring(0, 100) + '...',
                companyName: companyName || 'Not provided',
                resumeFileName: resumeFile?.name || 'No file',
                resumeFileSize: resumeFile?.size || 0
            });

            return formData;
        }

        function showLoading(show) {
            const loading = document.getElementById('loading');
            const buttons = document.querySelectorAll('button');

            loading.style.display = show ? 'block' : 'none';
            buttons.forEach(btn => btn.disabled = show);
        }

        function hideResult() {
            document.getElementById('result').style.display = 'none';
        }

        function clearResults() {
            hideResult();
            console.log('Results cleared');
        }

        function showSuccess(result, userType) {
            const resultDiv = document.getElementById('result');

            let content = `<h3>✅ ATS Score Calculated Successfully!</h3>`;

            // Display ATS Score prominently
            if (result.atsScore !== undefined) {
                content += `
                    <div class="ats-score-display">
                        <h3>🎯 Your ATS Score</h3>
                        <div class="score">${result.atsScore}%</div>
                        <p>Based on job description analysis</p>
                    </div>
                `;
            }

            // Add metadata section
            content += `
                <div class="metadata-section">
                    <h4>📊 Response Metadata:</h4>
                    <p><strong>User Type Tested:</strong> ${userType.replace('-', ' ')}</p>
                    <p><strong>Resume Source:</strong> ${result.resumeSource || 'Not specified'}</p>
                    <p><strong>Processing Time:</strong> ${result.processingTime || 'Not provided'}</p>
                    ${result.atsMatchHistoryId ? `<p><strong>History ID:</strong> ${result.atsMatchHistoryId}</p>` : ''}
                </div>
            `;

            // Add suggestions if available
            if (result.suggestions && result.suggestions.length > 0) {
                content += `
                    <details class="toggle-section">
                        <summary>💡 ATS Improvement Suggestions (${result.suggestions.length})</summary>
                        <div style="padding: 10px;">
                            <ul>
                                ${result.suggestions.map(suggestion => `<li>${suggestion}</li>`).join('')}
                            </ul>
                        </div>
                    </details>
                `;
            }

            // Add keywords if available
            if (result.matchedKeywords && result.matchedKeywords.length > 0) {
                content += `
                    <details class="toggle-section">
                        <summary>🔑 Matched Keywords (${result.matchedKeywords.length})</summary>
                        <div style="padding: 10px;">
                            <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                                ${result.matchedKeywords.map(keyword =>
                    `<span style="background: #e3f2fd; padding: 4px 8px; border-radius: 4px; font-size: 12px;">${keyword}</span>`
                ).join('')}
                            </div>
                        </div>
                    </details>
                `;
            }

            // Add full response
            content += `
                <details class="toggle-section">
                    <summary>📋 Full Response JSON</summary>
                    <pre>${JSON.stringify(result, null, 2)}</pre>
                </details>
            `;

            resultDiv.innerHTML = content;
            resultDiv.className = 'result success';
            resultDiv.style.display = 'block';
        }

        function showError(error, userType, statusCode) {
            const resultDiv = document.getElementById('result');

            let content = `<h3>❌ ATS Score Request Failed</h3>`;

            // Determine if this was an expected validation error
            const isExpectedValidation = (
                (userType === 'registered-with-resume' || userType === 'premium-with-resume') &&
                statusCode === 400 &&
                error.errorCode === 'ERR_SINGLE_RESUME_UPLOAD_ALLOWED'
            );

            if (isExpectedValidation) {
                content = `<h3>✅ Validation Working Correctly!</h3>`;
                resultDiv.className = 'result warning';
            } else {
                resultDiv.className = 'result error';
            }

            content += `
                <div class="metadata-section">
                    <h4>📊 Error Details:</h4>
                    <p><strong>User Type Tested:</strong> ${userType.replace('-', ' ')}</p>
                    <p><strong>HTTP Status:</strong> ${statusCode || 'Unknown'}</p>
                    <p><strong>Error Code:</strong> ${error.errorCode || error.code || 'Not provided'}</p>
                    <p><strong>Message:</strong> ${error.message || 'Unknown error'}</p>
                </div>
            `;

            if (isExpectedValidation) {
                content += `
                    <div style="background: #fff3cd; padding: 15px; border-radius: 4px; margin: 15px 0; border-left: 4px solid #ffc107;">
                        <h4 style="color: #856404; margin: 0 0 10px 0;">🎉 Expected Behavior!</h4>
                        <p style="color: #856404; margin: 0;">
                            This error is expected for users with processed resumes who try to upload files. 
                            The validation is working correctly - registered/premium users with processed resumes 
                            cannot upload new files and must use their existing database resume.
                        </p>
                    </div>
                `;
            }

            // Add validation errors if available
            if (error.errors && error.errors.length > 0) {
                content += `
                    <details class="toggle-section">
                        <summary>⚠️ Validation Errors (${error.errors.length})</summary>
                        <div style="padding: 10px;">
                            <ul>
                                ${error.errors.map(err => `<li>${err.field}: ${err.message}</li>`).join('')}
                            </ul>
                        </div>
                    </details>
                `;
            }

            // Add full error response
            content += `
                <details class="toggle-section">
                    <summary>📋 Full Error Response</summary>
                    <pre>${JSON.stringify(error, null, 2)}</pre>
                </details>
            `;

            resultDiv.innerHTML = content;
            resultDiv.style.display = 'block';
        }

        // Auto-fill sample data and setup on page load
        window.addEventListener('load', function () {
            console.log('🎯 ATS Score Test Page loaded');
            console.log('API Base URL:', API_BASE_URL);
            console.log('User contexts configured:', Object.keys(USER_CONTEXTS));
            console.log('Ready to test all scenarios!');

            // Log the validation rules for each user type
            console.log('Validation scenarios:');
            console.log('- Guest: Must upload file');
            console.log('- Registered (no resume): Must upload file');
            console.log('- Registered (with resume): Cannot upload file, uses DB');
            console.log('- Premium (with resume): Cannot upload file, uses DB');
        });
    </script>
</body>

</html>